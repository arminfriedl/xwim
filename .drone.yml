kind: pipeline
type: docker
name: default

steps:
- name: build
  image: arminfriedl/xwim-build
  commands:
    - meson build
    - ninja -C build

trigger:
  event:
    exclude:
    - tag

---
kind: pipeline
type: docker
name: release

steps:
- name: build-musl
  image: arminfriedl/xwim-build
  commands:
    - LDFLAGS="-static-libstdc++ -static-libgcc" meson --buildtype=release build
    - ninja -C build
    - mkdir xwim-${DRONE_TAG}-x86_64-musl-linux
    - mv build/src/xwim xwim-${DRONE_TAG}-x86_64-musl-linux

- name: package
  image: arminfriedl/xwim-build
  commands:
    - tar cjf xwim-${DRONE_TAG}-x86_64-musl-linux.tar.bz2 xwim-${DRONE_TAG}-x86_64-musl-linux/xwim
    - tar czf xwim-${DRONE_TAG}-x86_64-musl-linux.tar.gz xwim-${DRONE_TAG}-x86_64-musl-linux/xwim
    - zip -r xwim-${DRONE_TAG}-x86_64-musl-linux.zip xwim-${DRONE_TAG}-x86_64-musl-linux

- name: publish
  image: plugins/gitea-release
  settings:
    base_url: https://git.friedl.net
    api_key:
      from_secret: gitea_token
    files:
      - xwim-${DRONE_TAG}-x86_64-musl-linux.tar.bz2
      - xwim-${DRONE_TAG}-x86_64-musl-linux.tar.gz
      - xwim-${DRONE_TAG}-x86_64-musl-linux.zip
    title: xwim ${DRONE_TAG}
    checksum:
      - md5
      - sha256

trigger:
  event:
  - tag
